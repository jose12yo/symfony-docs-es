
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Cómo trabajar con ámbitos &mdash; Manual de Symfony2 en Español</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2.0.6',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/translations.js"></script>
    <link rel="top" title="Manual de Symfony2 en Español" href="../../index.html" />
    <link rel="up" title="Recetario" href="../index.html" />
    <link rel="next" title="Cómo utilizar PdoSessionStorage para almacenar sesiones en la base de datos" href="../configuration/pdo_session_storage.html" />
    <link rel="prev" title="Cómo gestionar dependencias comunes con servicios padre" href="parentservices.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="Índice General"
             accesskey="I">índice</a></li>
        <li class="right" >
          <a href="../configuration/pdo_session_storage.html" title="Cómo utilizar PdoSessionStorage para almacenar sesiones en la base de datos"
             accesskey="N">siguiente</a> |</li>
        <li class="right" >
          <a href="parentservices.html" title="Cómo gestionar dependencias comunes con servicios padre"
             accesskey="P">anterior</a> |</li>
        <li><a href="../../index.html">Symfony2</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Recetario</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="como-trabajar-con-ambitos">
<h1>Cómo trabajar con ámbitos<a class="headerlink" href="#como-trabajar-con-ambitos" title="Enlazar permanentemente con este título">¶</a></h1>
<p>Esta entrada trata sobre los ámbitos, un tema un tanto avanzado relacionado con el <a class="reference internal" href="../../book/service_container.html"><em>Contenedor de servicios</em></a>. Si alguna vez has tenido un error hablando de &#8220;ámbitos&#8221; en la creación de servicios o necesitas crear un servicio que depende del servicio <tt class="docutils literal"><span class="pre">petición</span></tt>, entonces este artículo es para ti.</p>
<div class="section" id="entendiendo-los-ambitos">
<h2>Entendiendo los ámbitos<a class="headerlink" href="#entendiendo-los-ambitos" title="Enlazar permanentemente con este título">¶</a></h2>
<p>El ámbito de un servicio controla la duración de una instancia de un servicio utilizado por el contenedor. el componente de inyección de dependencias tiene dos ámbitos genéricos:</p>
<ul class="simple">
<li><strong>container</strong> (la opción predeterminada): Usa la misma instancia cada vez que la solicites desde el contenedor.</li>
<li><strong>prototype</strong>: Crea una nueva instancia cada vez que solicitas el servicio.</li>
</ul>
<p>El <tt class="docutils literal"><span class="pre">FrameworkBundle</span></tt> también define un tercer ámbito: <tt class="docutils literal"><span class="pre">request</span></tt>. Estos ámbitos están ligados a la petición, lo cual significa que se crea una nueva instancia para cada subpetición y no está disponible fuera de la petición (por ejemplo, en el <em>CLI</em>).</p>
<p>Los ámbitos agregan una restricción en las dependencias de un servicio: un servicio no puede depender de los servicios de un ámbito más estrecho. Por ejemplo, si creas un servicio <tt class="docutils literal"><span class="pre">mi_foo</span></tt> genérico, pero tratas de inyectar el componente <tt class="docutils literal"><span class="pre">petición</span></tt>, recibirás un: class:<cite>Symfony\Component\DependencyInjection\Exception\ScopeWideningInjectionException</cite> al compilar el contenedor . Lee la barra lateral más abajo para más detalles.</p>
<div class="sidebar">
<p class="first sidebar-title">Ámbitos y dependencias</p>
<p>Imaginemos que has configurado un servicio <tt class="docutils literal"><span class="pre">my_mailer</span></tt>. No has configurado el ámbito del servicio, por lo cual el predeterminado es el <tt class="docutils literal"><span class="pre">contenedor</span></tt>. En otras palabras, cada vez que solicitas el <tt class="docutils literal"><span class="pre">contenedor</span></tt> para el servicio <tt class="docutils literal"><span class="pre">my_mailer</span></tt>, obtienes el mismo objeto de nuevo. Esta, por lo general, es la forma en que deseas que trabajen tus servicios.</p>
<p>Imaginemos, sin embargo, que es necesario el servicio <tt class="docutils literal"><span class="pre">petición</span></tt> en tu servicio <tt class="docutils literal"><span class="pre">my_mailer</span></tt>, tal vez porque estás leyendo la <em>URL</em> de la <tt class="docutils literal"><span class="pre">petición</span></tt> actual.
Por lo tanto, lo agregas como argumento del constructor. Veamos por qué esto presenta un problema:</p>
<ul class="last">
<li><p class="first">Al solicitar <tt class="docutils literal"><span class="pre">my_mailer</span></tt>, se crea una instancia de <tt class="docutils literal"><span class="pre">my_mailer</span></tt> (llamémosla <tt class="docutils literal"><span class="pre">MailerA</span></tt>) y se pasa al servicio <tt class="docutils literal"><span class="pre">petición</span></tt> (vamos a llamarlo <tt class="docutils literal"><span class="pre">RequestA</span></tt>). ¡La vida es buena!</p>
</li>
<li><p class="first">Has hecho una subpetición en <em>Symfony</em>, esta es una forma elegante de decir que has llamado, por ejemplo, a la función <tt class="docutils literal"><span class="pre">{%</span> <span class="pre">render</span> <span class="pre">...</span> <span class="pre">%}</span></tt> de <em>Twig</em>, que ejecuta otro controlador. Internamente, el antiguo servicio <tt class="docutils literal"><span class="pre">petición</span></tt> (<tt class="docutils literal"><span class="pre">RequestA</span></tt>) en realidad es reemplazado por una instancia de la nueva petición (<tt class="docutils literal"><span class="pre">RequestB</span></tt>).
Esto sucede en segundo plano, y es totalmente normal.</p>
</li>
<li><p class="first">En tu controlador incorporado, una vez más invocas al servicio <tt class="docutils literal"><span class="pre">my_mailer</span></tt>. Debido a que tu servicio está en el ámbito del <tt class="docutils literal"><span class="pre">contenedor</span></tt>, se vuelve a utilizar la misma instancia (<tt class="docutils literal"><span class="pre">MailerA</span></tt>). Pero aquí está el problema: la instancia de <tt class="docutils literal"><span class="pre">MailerA</span></tt> contiene todavía el viejo objeto <tt class="docutils literal"><span class="pre">RequestA</span></tt>, que ahora <strong>no</strong> es el objeto de petición correcto (<tt class="docutils literal"><span class="pre">RequestB</span></tt> ahora es el servicio <tt class="docutils literal"><span class="pre">petición</span></tt> actual). Esto es sutil, pero el desajuste puede causar grandes problemas, lo cual no está permitido.</p>
<p>Por lo tanto, esa es la razón por la <em>cual</em> existen los ámbitos, y la forma en que pueden causar problemas. Sigue leyendo para encontrar las soluciones comunes.</p>
</li>
</ul>
</div>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">Un servicio puede, por supuesto, depender de un servicio desde un ámbito más amplio sin ningún problema.</p>
</div>
</div>
<div class="section" id="estableciendo-el-ambito-en-la-definicion">
<h2>Estableciendo el ámbito en la definición<a class="headerlink" href="#estableciendo-el-ambito-en-la-definicion" title="Enlazar permanentemente con este título">¶</a></h2>
<p>El ámbito de un servicio se establece en la definición del servicio:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># src/Acme/HelloBundle/Resources/config/services.yml</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">greeting_card_manager</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">class</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Acme\HelloBundle\Mail\GreetingCardManager</span>
        <span class="l-Scalar-Plain">scope</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">request</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- src/Acme/HelloBundle/Resources/config/services.xml --&gt;</span>
<span class="nt">&lt;services&gt;</span>
    <span class="nt">&lt;service</span> <span class="na">id=</span><span class="s">&quot;greeting_card_manager&quot;</span> <span class="na">class=</span><span class="s">&quot;Acme\HelloBundle\Mail\GreetingCardManager&quot;</span> <span class="na">scope=</span><span class="s">&quot;request&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/services&gt;</span>
</pre></div>
</div>
</li>
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span class="x">// src/Acme/HelloBundle/Resources/config/services.php</span>
<span class="x">use Symfony\Component\DependencyInjection\Definition;</span>

<span class="x">$container-&gt;setDefinition(</span>
<span class="x">    &#39;greeting_card_manager&#39;,</span>
<span class="x">    new Definition(&#39;Acme\HelloBundle\Mail\GreetingCardManager&#39;)</span>
<span class="x">)-&gt;setScope(&#39;request&#39;);</span>
</pre></div>
</div>
</li>
</ul>
</div>
<p>Si no especificas el ámbito, el valor predeterminado es <tt class="docutils literal"><span class="pre">contenedor</span></tt>, el cual es el que quieres la mayor parte del tiempo. A menos que tu servicio dependa de otro servicio que aplica su ámbito más restringido (por lo general, el servicio <tt class="docutils literal"><span class="pre">petición</span></tt>), es probable que no sea necesario definir el ámbito.</p>
</div>
<div class="section" id="usando-un-servicio-de-menor-ambito">
<h2>Usando un servicio de menor ámbito<a class="headerlink" href="#usando-un-servicio-de-menor-ambito" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Si tu servicio depende del ámbito de un servicio, la mejor solución es ponerlo en el mismo ámbito (o uno más estrecho). Normalmente, esto significa poner tu nuevo servicio en el ámbito de la <tt class="docutils literal"><span class="pre">Petición</span></tt>.</p>
<p>Pero esto no siempre es posible (por ejemplo, una extensión de <em>Twig</em> debe estar en el ámbito del <tt class="docutils literal"><span class="pre">contenedor</span></tt> como el entorno <em>Twig</em> que necesita como dependencia).
En estos casos, debes pasar todo el contenedor en tu servicio y recuperar tu dependencia desde el contenedor cada vez que lo necesites para asegurarte de que tienes la instancia correcta:</p>
<div class="highlight-python"><pre>namespace Acme\HelloBundle\Mail;

use Symfony\Component\DependencyInjection\ContainerInterface;

class Mailer
{
    protected $container;

    public function __construct(ContainerInterface $container)
    {
        $this-&gt;container = $container;
    }

    public function sendEmail()
    {
        $request = $this-&gt;container-&gt;get('request');
        // hace algo con la respuesta de redirección
    }
}</pre>
</div>
<div class="admonition caution">
<p class="first admonition-title">Prudencia</p>
<p class="last">Ten cuidado de no guardar la petición en una propiedad del objeto para una futura llamada del servicio, ya que sería el mismo problema descrito en la primera sección (excepto que <em>Symfony</em> no puede detectar qué estás haciendo mal).</p>
</div>
<p>La configuración del servicio de esta clase sería algo como esto:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="highlight-yaml"><pre># src/Acme/HelloBundle/Resources/config/services.yml
parameters:
    # ...
    my_mailer.class: Acme\HelloBundle\Mail\Mailer
services:
    my_mailer:
        class:     %my_mailer.class%
        arguments:
            - "@service_container"
        # scope: container can be omitted as it is the default</pre>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- src/Acme/HelloBundle/Resources/config/services.xml --&gt;</span>
<span class="nt">&lt;parameters&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
    <span class="nt">&lt;parameter</span> <span class="na">key=</span><span class="s">&quot;my_mailer.class&quot;</span><span class="nt">&gt;</span>Acme\HelloBundle\Mail\Mailer<span class="nt">&lt;/parameter&gt;</span>
<span class="nt">&lt;/parameters&gt;</span>

<span class="nt">&lt;services&gt;</span>
    <span class="nt">&lt;service</span> <span class="na">id=</span><span class="s">&quot;my_mailer&quot;</span> <span class="na">class=</span><span class="s">&quot;%my_mailer.class%&quot;</span><span class="nt">&gt;</span>
         <span class="nt">&lt;argument</span> <span class="na">type=</span><span class="s">&quot;service&quot;</span> <span class="na">id=</span><span class="s">&quot;service_container&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/service&gt;</span>
<span class="nt">&lt;/services&gt;</span>
</pre></div>
</div>
</li>
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span class="x">// src/Acme/HelloBundle/Resources/config/services.php</span>
<span class="x">use Symfony\Component\DependencyInjection\Definition;</span>
<span class="x">use Symfony\Component\DependencyInjection\Reference;</span>

<span class="x">// ...</span>
<span class="x">$container-&gt;setParameter(&#39;my_mailer.class&#39;, &#39;Acme\HelloBundle\Mail\Mailer&#39;);</span>

<span class="x">$container-&gt;setDefinition(&#39;my_mailer&#39;, new Definition(</span>
<span class="x">    &#39;%my_mailer.class%&#39;,</span>
<span class="x">    array(new Reference(&#39;service_container&#39;))</span>
<span class="x">));</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">Inyectar el contenedor completo en un servicio generalmente no es una buena idea (inyecta sólo lo que necesitas). En algunos raros casos, es necesario cuando tienes un servicio en el entorno del <tt class="docutils literal"><span class="pre">Contenedor</span></tt> que necesita un servicio del ámbito de la <tt class="docutils literal"><span class="pre">Petición</span></tt>.</p>
</div>
<p>Si defines un controlador como servicio entonces puedes obtener el objeto <tt class="docutils literal"><span class="pre">Petición</span></tt> sin inyectar el contenedor pasándolo como argumento de tu método acción. Consulta <a class="reference internal" href="../../book/controller.html#book-controller-request-argument"><em>La Petición como argumento para el controlador</em></a> para detalles.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Contenidos</a></h3>
  <ul>
<li><a class="reference internal" href="#">Cómo trabajar con ámbitos</a><ul>
<li><a class="reference internal" href="#entendiendo-los-ambitos">Entendiendo los ámbitos</a></li>
<li><a class="reference internal" href="#estableciendo-el-ambito-en-la-definicion">Estableciendo el ámbito en la definición</a></li>
<li><a class="reference internal" href="#usando-un-servicio-de-menor-ambito">Usando un servicio de menor ámbito</a></li>
</ul>
</li>
</ul>

  <h4>Tema anterior</h4>
  <p class="topless"><a href="parentservices.html"
                        title="Capítulo anterior">Cómo gestionar dependencias comunes con servicios padre</a></p>
  <h4>Próximo tema</h4>
  <p class="topless"><a href="../configuration/pdo_session_storage.html"
                        title="Próximo capítulo">Cómo utilizar <tt class="docutils literal docutils literal docutils literal"><span class="pre">PdoSessionStorage</span></tt> para almacenar sesiones en la base de datos</a></p>
<div id="searchbox" style="display: none">
  <h3>Búsqueda rápida</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Ir a" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="Índice General"
             >índice</a></li>
        <li class="right" >
          <a href="../configuration/pdo_session_storage.html" title="Cómo utilizar PdoSessionStorage para almacenar sesiones en la base de datos"
             >siguiente</a> |</li>
        <li class="right" >
          <a href="parentservices.html" title="Cómo gestionar dependencias comunes con servicios padre"
             >anterior</a> |</li>
        <li><a href="../../index.html">Symfony2</a> &raquo;</li>
          <li><a href="../index.html" >Recetario</a> &raquo;</li> 
      </ul>
    </div>
   <div id="disqus_thread"></div>
   
    <div class="footer">
        &copy; Copyright 2011, Traducido por Nacho Pacheco.
      Actualizado por última vez en Dec 05, 2011.
      Creado con <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.2.
    </div>
   <script type="text/javascript"> 
    var disqus_shortname = 'documentos-mx';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
   </script> 
   <noscript>
     Por favor activa JavaScript para ver los <a href="http://disqus.com/?ref_noscript">comentarios accionados por Disqus.</a>
   </noscript>

  </body>
</html>