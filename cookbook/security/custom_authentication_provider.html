
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Cómo crear un proveedor de autenticación personalizado &mdash; Manual de Symfony2 en Español</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2.0.6',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/translations.js"></script>
    <link rel="top" title="Manual de Symfony2 en Español" href="../../index.html" />
    <link rel="up" title="Recetario" href="../index.html" />
    <link rel="next" title="Cómo cambiar el comportamiento predeterminado de la ruta destino" href="target_path.html" />
    <link rel="prev" title="Cómo crear un proveedor de usuario personalizado" href="custom_provider.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="Índice General"
             accesskey="I">índice</a></li>
        <li class="right" >
          <a href="target_path.html" title="Cómo cambiar el comportamiento predeterminado de la ruta destino"
             accesskey="N">siguiente</a> |</li>
        <li class="right" >
          <a href="custom_provider.html" title="Cómo crear un proveedor de usuario personalizado"
             accesskey="P">anterior</a> |</li>
        <li><a href="../../index.html">Symfony2</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Recetario</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="como-crear-un-proveedor-de-autenticacion-personalizado">
<span id="index-0"></span><h1>Cómo crear un proveedor de autenticación personalizado<a class="headerlink" href="#como-crear-un-proveedor-de-autenticacion-personalizado" title="Enlazar permanentemente con este título">¶</a></h1>
<p>Si has leído el capítulo sobre <a class="reference internal" href="../../book/security.html"><em>Seguridad</em></a>, entiendes la distinción que <em>Symfony2</em> hace entre autenticación y autorización en la implementación de la seguridad. Este capítulo cubre las clases del núcleo involucradas en el proceso de autenticación, y cómo implementar un proveedor de autenticación personalizado. Dado que la autenticación y autorización son conceptos independientes, esta extensión será un proveedor de usuario agnóstico, y funcionará con los proveedores de usuario de la aplicación, posiblemente basado en memoria, en una base de datos, o en cualquier otro lugar que elijas almacenarlos.</p>
<div class="section" id="conociendo-wsse">
<h2>Conociendo <em>WSSE</em><a class="headerlink" href="#conociendo-wsse" title="Enlazar permanentemente con este título">¶</a></h2>
<p>El siguiente capítulo demuestra cómo crear un proveedor de autenticación personalizado para la autenticación <em>WSSE</em>. El protocolo de seguridad para <em>WSSE</em> proporciona varias ventajas de seguridad:</p>
<ol class="arabic simple">
<li>Cifrado del Nombre de usuario/Contraseña</li>
<li>Salvaguardado contra ataques repetitivos</li>
<li>No requiere configuración del servidor web</li>
</ol>
<p><em>WSSE</em> es muy útil para proteger servicios <em>web</em>, pudiendo ser <em>SOAP</em> o <em>REST</em>.</p>
<p>Hay un montón de excelente documentación sobre <a class="reference external" href="http://www.xml.com/pub/a/2003/12/17/dive.html">WSSE</a>, pero este artículo no se enfocará en el protocolo de seguridad, sino más bien en la manera en que puedes personalizar el protocolo para añadirlo a tu aplicación <em>Symfony2</em>. La base de <em>WSSE</em> es que un encabezado de la petición comprueba si las credenciales están cifradas, verificando una marca de tiempo y <a class="reference external" href="http://en.wikipedia.org/wiki/Cryptographic_nonce">nonce</a>, y autenticado por el usuario de la petición asimilando una contraseña.</p>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">WSSE también es compatible con aplicaciones de validación de clave, lo cual es útil para los servicios web, pero está fuera del alcance de este capítulo.</p>
</div>
</div>
<div class="section" id="el-testigo">
<h2>El testigo<a class="headerlink" href="#el-testigo" title="Enlazar permanentemente con este título">¶</a></h2>
<p>El papel del testigo en el contexto de la seguridad en <em>Symfony2</em> es muy importante.
Un testigo representa los datos de autenticación del usuario en la petición. Una vez se ha autenticado una petición, el testigo conserva los datos del usuario, y proporciona estos datos a través del contexto de seguridad. En primer lugar, vamos a crear nuestra clase testigo.
Esta permitirá pasar toda la información pertinente a nuestro proveedor de autenticación.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">// src/Acme/DemoBundle/Security/Authentication/Token/WsseUserToken.php</span>
<span class="x">namespace Acme\DemoBundle\Security\Authentication\Token;</span>

<span class="x">use Symfony\Component\Security\Core\Authentication\Token\AbstractToken;</span>

<span class="x">class WsseUserToken extends AbstractToken</span>
<span class="x">{</span>
<span class="x">    public $created;</span>
<span class="x">    public $digest;</span>
<span class="x">    public $nonce;</span>

<span class="x">    public function getCredentials()</span>
<span class="x">    {</span>
<span class="x">        return &#39;&#39;;</span>
<span class="x">    }</span>
<span class="x">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">La clase <tt class="docutils literal"><span class="pre">WsseUserToken</span></tt> extiende la clase componente de <tt class="docutils literal"><span class="pre">seguridad</span></tt> <tt class="xref py py-class docutils literal"><span class="pre">Symfony\Component\Security\Core\Autenticación\Token\AbstractToken</span></tt>, que proporciona una funcionalidad de testigo básica. Implementa la clase <tt class="xref py py-class docutils literal"><span class="pre">Symfony\Component\Security\Core\Authentication\Token\TokenInterface</span></tt> en cualquier clase que utilices como testigo.</p>
</div>
</div>
<div class="section" id="el-escucha">
<h2>El escucha<a class="headerlink" href="#el-escucha" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Después, necesitas un escucha para que esté atento al contexto de seguridad. El escucha es el responsable de capturar las peticiones de seguridad al servidor e invocar al proveedor de autenticación. Un escucha debe ser una instancia de <tt class="xref py py-class docutils literal"><span class="pre">Symfony\Component\Security\Http\Firewall\ListenerInterface</span></tt>.
Un escucha de seguridad debería manejar el evento <tt class="xref py py-class docutils literal"><span class="pre">Symfony\Component\HttpKernel\Event\GetResponseEvent</span></tt>, y establecer el testigo autenticado en el contexto de seguridad en caso de éxito.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">// src/Acme/DemoBundle/Security/Firewall/WsseListener.php</span>
<span class="x">namespace Acme\DemoBundle\Security\Firewall;</span>

<span class="x">use Symfony\Component\HttpFoundation\Response;</span>
<span class="x">use Symfony\Component\HttpKernel\Event\GetResponseEvent;</span>
<span class="x">use Symfony\Component\Security\Http\Firewall\ListenerInterface;</span>
<span class="x">use Symfony\Component\Security\Core\Exception\AuthenticationException;</span>
<span class="x">use Symfony\Component\Security\Core\SecurityContextInterface;</span>
<span class="x">use Symfony\Component\Security\Core\Authentication\AuthenticationManagerInterface;</span>
<span class="x">use Symfony\Component\Security\Core\Authentication\Token\TokenInterface;</span>
<span class="x">use Acme\DemoBundle\Security\Authentication\Token\WsseUserToken;</span>

<span class="x">class WsseListener implements ListenerInterface</span>
<span class="x">{</span>
<span class="x">    protected $securityContext;</span>
<span class="x">    protected $authenticationManager;</span>

<span class="x">    public function __construct(SecurityContextInterface $securityContext, AuthenticationManagerInterface $authenticationManager)</span>
<span class="x">    {</span>
<span class="x">        $this-&gt;securityContext = $securityContext;</span>
<span class="x">        $this-&gt;authenticationManager = $authenticationManager;</span>
<span class="x">    }</span>

<span class="x">    public function handle(GetResponseEvent $event)</span>
<span class="x">    {</span>
<span class="x">        $request = $event-&gt;getRequest();</span>

<span class="x">        if (!$request-&gt;headers-&gt;has(&#39;x-wsse&#39;)) {</span>
<span class="x">            return;</span>
<span class="x">        }</span>

<span class="x">        $wsseRegex = &#39;/UsernameToken Username=&quot;([^&quot;]+)&quot;, PasswordDigest=&quot;([^&quot;]+)&quot;, Nonce=&quot;([^&quot;]+)&quot;, Creado=&quot;([^&quot;]+)&quot;/&#39;;</span>

<span class="x">        if (preg_match($wsseRegex, $request-&gt;headers-&gt;get(&#39;x-wsse&#39;), $matches)) {</span>
<span class="x">            $token = new WsseUserToken();</span>
<span class="x">            $token-&gt;setUser($matches[1]);</span>

<span class="x">            $token-&gt;digest   = $matches[2];</span>
<span class="x">            $token-&gt;nonce    = $matches[3];</span>
<span class="x">            $token-&gt;created  = $matches[4];</span>

<span class="x">            try {</span>
<span class="x">                $returnValue = $this-&gt;authenticationManager-&gt;authenticate($token);</span>

<span class="x">                if ($returnValue instanceof TokenInterface) {</span>
<span class="x">                    return $this-&gt;securityContext-&gt;setToken($returnValue);</span>
<span class="x">                } else if ($returnValue instanceof Response) {</span>
<span class="x">                    return $event-&gt;setResponse($returnValue);</span>
<span class="x">                }</span>
<span class="x">            } catch (AuthenticationException $e) {</span>
<span class="x">                // aquí puedes registrar alguna cosa</span>
<span class="x">            }</span>
<span class="x">        }</span>

<span class="x">        $response = new Response();</span>
<span class="x">        $response-&gt;setStatusCode(403);</span>
<span class="x">        $event-&gt;setResponse($response);</span>
<span class="x">    }</span>
<span class="x">}</span>
</pre></div>
</div>
<p>Este escucha comprueba que la petición tenga la cabecera <tt class="docutils literal"><span class="pre">X-WSSE</span></tt> esperada, empareja el valor devuelto con la información <tt class="docutils literal"><span class="pre">WSSE</span></tt> esperada, crea un testigo utilizando esa información, y pasa el testigo al gestor de autenticación. Si no proporcionas la información adecuada, o el gestor de autenticación lanza una <tt class="xref py py-class docutils literal"><span class="pre">Symfony\Component\Security\Core\Exception\AuthenticationException</span></tt>, devuelve una respuesta 403.</p>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">Una clase no usada arriba, <tt class="xref py py-class docutils literal"><span class="pre">Symfony\Component\Security\Http\Firewall\AbstractAuthenticationListener</span></tt>, es una clase base muy útil que proporciona funcionalidad necesaria comúnmente por las extensiones de seguridad. Esto incluye mantener al testigo en la sesión, proporcionando manipuladores de éxito / fallo, <em>url</em> del formulario de acceso y mucho más. Puesto que <em>WSSE</em> no requiere mantener la autenticación entre sesiones o formularios de acceso, no la utilizaremos para este ejemplo.</p>
</div>
</div>
<div class="section" id="proveedor-de-autenticacion">
<h2>Proveedor de autenticación<a class="headerlink" href="#proveedor-de-autenticacion" title="Enlazar permanentemente con este título">¶</a></h2>
<p>El proveedor de autenticación debe hacer la verificación del <tt class="docutils literal"><span class="pre">WsseUserToken</span></tt>.
Es decir, el proveedor verificará si es válido el valor de la cabecera <tt class="docutils literal"><span class="pre">Created</span></tt> dentro de los cinco minutos, el valor de la cabecera <tt class="docutils literal"><span class="pre">Nonce</span></tt> es único dentro de los cinco minutos, y  el valor de la cabecera <tt class="docutils literal"><span class="pre">PasswordDigest</span></tt> coincide con la contraseña del usuario.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">// src/Acme/DemoBundle/Security/Authentication/Provider/WsseProvider.php</span>
<span class="x">namespace Acme\DemoBundle\Security\Authentication\Provider;</span>

<span class="x">use Symfony\Component\Security\Core\Authentication\Provider\AuthenticationProviderInterface;</span>
<span class="x">use Symfony\Component\Security\Core\User\UserProviderInterface;</span>
<span class="x">use Symfony\Component\Security\Core\Exception\AuthenticationException;</span>
<span class="x">use Symfony\Component\Security\Core\Exception\NonceExpiredException;</span>
<span class="x">use Symfony\Component\Security\Core\Authentication\Token\TokenInterface;</span>
<span class="x">use Acme\DemoBundle\Security\Authentication\Token\WsseUserToken;</span>

<span class="x">class WsseProvider implements AuthenticationProviderInterface</span>
<span class="x">{</span>
<span class="x">    private $userProvider;</span>
<span class="x">    private $cacheDir;</span>

<span class="x">    public function __construct(UserProviderInterface $userProvider, $cacheDir)</span>
<span class="x">    {</span>
<span class="x">        $this-&gt;userProvider = $userProvider;</span>
<span class="x">        $this-&gt;cacheDir     = $cacheDir;</span>
<span class="x">    }</span>

<span class="x">    public function authenticate(TokenInterface $token)</span>
<span class="x">    {</span>
<span class="x">        $user = $this-&gt;userProvider-&gt;loadUserByUsername($token-&gt;getUsername());</span>

<span class="x">        if ($user &amp;&amp; $this-&gt;validateDigest($token-&gt;digest, $token-&gt;nonce, $token-&gt;created, $user-&gt;getPassword())) {</span>
<span class="x">            $authenticatedToken = new WsseUserToken($user-&gt;getRoles());</span>
<span class="x">            $authenticatedToken-&gt;setUser($user);</span>

<span class="x">            return $authenticatedToken;</span>
<span class="x">        }</span>

<span class="x">        throw new AuthenticationException(&#39;The WSSE authentication failed.&#39;);</span>
<span class="x">    }</span>

<span class="x">    protected function validateDigest($digest, $nonce, $created, $secret)</span>
<span class="x">    {</span>
<span class="x">        // la marca de tiempo caduca después de 5 minutos</span>
<span class="x">        if (time() - strtotime($created) &gt; 300) {</span>
<span class="x">            return false;</span>
<span class="x">        }</span>

<span class="x">        // Valida que $nonce es única en 5 minutos</span>
<span class="x">        if (file_exists($this-&gt;cacheDir.&#39;/&#39;.$nonce) &amp;&amp; file_get_contents($this-&gt;cacheDir.&#39;/&#39;.$nonce) + 300 &lt; time()) {</span>
<span class="x">            throw new NonceExpiredException(&#39;Previously used nonce detected&#39;);</span>
<span class="x">        }</span>
<span class="x">        file_put_contents($this-&gt;cacheDir.&#39;/&#39;.$nonce, time());</span>

<span class="x">        // Valida secreto</span>
<span class="x">        $expected = base64_encode(sha1(base64_decode($nonce).$created.$secret, true));</span>

<span class="x">        return $digest === $expected;</span>
<span class="x">    }</span>

<span class="x">    public function supports(TokenInterface $token)</span>
<span class="x">    {</span>
<span class="x">        return $token instanceof WsseUserToken;</span>
<span class="x">    }</span>
<span class="x">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">La <tt class="xref py py-class docutils literal"><span class="pre">Symfony\Component\Security\Core\Authentication\Provider\AuthenticationProviderInterface</span></tt> requiere un método <tt class="docutils literal"><span class="pre">authenticate</span></tt> en el testigo del usuario, y un método <tt class="docutils literal"><span class="pre">supports</span></tt>, el cual informa al gestor de autenticación cuando o no utilizar este proveedor para el testigo dado. En el caso de múltiples proveedores, el gestor de autenticación entonces pasa al siguiente proveedor en la lista.</p>
</div>
</div>
<div class="section" id="la-fabrica">
<h2>La fábrica<a class="headerlink" href="#la-fabrica" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Has creado un testigo personalizado, escucha personalizado y proveedor personalizado. Ahora necesitas mantener todo junto. ¿Cómo hacer disponible tu proveedor en la configuración de seguridad? La respuesta es usando una <tt class="docutils literal"><span class="pre">fábrica</span></tt>. Una fábrica es donde enganchas el componente de seguridad, diciéndole el nombre de tu proveedor y las opciones de configuración disponibles para ello. En primer lugar, debes crear una clase que implemente <tt class="xref py py-class docutils literal"><span class="pre">Symfony\Bundle\SecurityBundle\DependencyInjection\Security\Factory\SecurityFactoryInterface</span></tt>.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">// src/Acme/DemoBundle/DependencyInjection/Security/Factory/WsseFactory.php</span>
<span class="x">namespace Acme\DemoBundle\DependencyInjection\Security\Factory;</span>

<span class="x">use Symfony\Component\DependencyInjection\ContainerBuilder;</span>
<span class="x">use Symfony\Component\DependencyInjection\Reference;</span>
<span class="x">use Symfony\Component\DependencyInjection\DefinitionDecorator;</span>
<span class="x">use Symfony\Component\Config\Definition\Builder\NodeDefinition;</span>
<span class="x">use Symfony\Bundle\SecurityBundle\DependencyInjection\Security\Factory\SecurityFactoryInterface;</span>

<span class="x">class WsseFactory implements SecurityFactoryInterface</span>
<span class="x">{</span>
<span class="x">    public function create(ContainerBuilder $container, $id, $config, $userProvider, $defaultEntryPoint)</span>
<span class="x">    {</span>
<span class="x">        $providerId = &#39;security.authentication.provider.wsse.&#39;.$id;</span>
<span class="x">        $container</span>
<span class="x">            -&gt;setDefinition($providerId, new DefinitionDecorator(&#39;wsse.security.authentication.provider&#39;))</span>
<span class="x">            -&gt;replaceArgument(0, new Reference($userProvider))</span>
<span class="x">        ;</span>

<span class="x">        $listenerId = &#39;security.authentication.listener.wsse.&#39;.$id;</span>
<span class="x">        $listener = $container-&gt;setDefinition($listenerId, new DefinitionDecorator(&#39;wsse.security.authentication.listener&#39;));</span>

<span class="x">        return array($providerId, $listenerId, $defaultEntryPoint);</span>
<span class="x">    }</span>

<span class="x">    public function getPosition()</span>
<span class="x">    {</span>
<span class="x">        return &#39;pre_auth&#39;;</span>
<span class="x">    }</span>

<span class="x">    public function getKey()</span>
<span class="x">    {</span>
<span class="x">        return &#39;wsse&#39;;</span>
<span class="x">    }</span>

<span class="x">    public function addConfiguration(NodeDefinition $node)</span>
<span class="x">    {}</span>
<span class="x">}</span>
</pre></div>
</div>
<p>La <tt class="xref py py-class docutils literal"><span class="pre">Symfony\Bundle\SecurityBundle\DependencyInjection\Security\Factory\SecurityFactoryInterface</span></tt> requiere los siguientes métodos:</p>
<ul class="simple">
<li>el método <tt class="docutils literal"><span class="pre">create</span></tt>, el cual añade el escucha y proveedor de autenticación para el contenedor de ID en el contexto de seguridad adecuado;</li>
<li>el método <tt class="docutils literal"><span class="pre">getPosition</span></tt>, el cual debe ser del tipo <tt class="docutils literal"><span class="pre">pre_auth</span></tt>, <tt class="docutils literal"><span class="pre">form</span></tt>, <tt class="docutils literal"><span class="pre">http</span></tt> y <tt class="docutils literal"><span class="pre">remember_me</span></tt> define la posición en la que se llama al proveedor;</li>
<li>el método <tt class="docutils literal"><span class="pre">getKey</span></tt> el cual define la clave de configuración utilizada para hacer referencia al proveedor;</li>
<li>el método <tt class="docutils literal"><span class="pre">addConfiguration</span></tt> el cual se utiliza para definir las opciones de configuración bajo la clave de configuración en tu configuración de seguridad.
Cómo ajustar las opciones de configuración se explica más adelante en este capítulo.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">Una clase no utilizada en este ejemplo, <tt class="xref py py-class docutils literal"><span class="pre">Symfony\Bundle\SecurityBundle\DependencyInjection\Security\Factory\AbstractFactory</span></tt>, es una clase base muy útil que proporciona una funcionalidad común necesaria para proteger la fábrica. Puede ser útil en la definición de un tipo proveedor de autenticación diferente.</p>
</div>
<p>Ahora que has creado una clase fábrica, puedes utilizar la clave <tt class="docutils literal"><span class="pre">wsse</span></tt> como un cortafuegos en tu configuración de seguridad.</p>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">Te estarás preguntando &#8220;¿por qué necesitamos una clase fábrica especial para añadir escuchas y proveedores en el contenedor de inyección de dependencias?&#8221;. Esta es una muy buena pregunta. La razón es que puedes utilizar tu cortafuegos varias veces, para proteger varias partes de tu aplicación. Debido a esto, cada vez que utilizas tu cortafuegos, se crea un nuevo servicio en el contenedor de ID.
La fábrica es la que crea estos nuevos servicios.</p>
</div>
</div>
<div class="section" id="configurando">
<h2>Configurando<a class="headerlink" href="#configurando" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Es hora de ver en acción tu proveedor de autenticación. Tendrás que hacer algunas cosas a fin de hacerlo funcionar. Lo primero es añadir los servicios mencionados al contenedor de ID. Tu clase fábrica anterior hace referencia a identificadores de servicio que aún no existen: <tt class="docutils literal"><span class="pre">wsse.security.authentication.provider</span></tt> y
<tt class="docutils literal"><span class="pre">wsse.security.authentication.listener</span></tt>. Es hora de definir esos servicios.</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="highlight-yaml"><pre># src/Acme/DemoBundle/Resources/config/services.yml
services:
  wsse.security.authentication.provider:
    class:  Acme\DemoBundle\Security\Authentication\Provider\WsseProvider
    arguments: ['', %kernel.cache_dir%/security/nonces]

  wsse.security.authentication.listener:
    class:  Acme\DemoBundle\Security\Firewall\WsseListener
    arguments: [@security.context, @security.authentication.manager]</pre>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- src/Acme/DemoBundle/Resources/config/services.xml --&gt;</span>
<span class="nt">&lt;services&gt;</span>
    <span class="nt">&lt;service</span> <span class="na">id=</span><span class="s">&quot;wsse.security.authentication.provider&quot;</span>
      <span class="na">class=</span><span class="s">&quot;Acme\DemoBundle\Security\Authentication\Provider\WsseProvider&quot;</span> <span class="na">public=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;argument</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- User Provider --&gt;</span>
        <span class="nt">&lt;argument&gt;</span>%kernel.cache_dir%/security/nonces<span class="nt">&lt;/argument&gt;</span>
    <span class="nt">&lt;/service&gt;</span>

    <span class="nt">&lt;service</span> <span class="na">id=</span><span class="s">&quot;wsse.security.authentication.listener&quot;</span>
      <span class="na">class=</span><span class="s">&quot;Acme\DemoBundle\Security\Firewall\WsseListener&quot;</span> <span class="na">public=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;argument</span> <span class="na">type=</span><span class="s">&quot;service&quot;</span> <span class="na">id=</span><span class="s">&quot;security.context&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;argument</span> <span class="na">type=</span><span class="s">&quot;service&quot;</span> <span class="na">id=</span><span class="s">&quot;security.authentication.manager&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/service&gt;</span>
<span class="nt">&lt;/services&gt;</span>
</pre></div>
</div>
</li>
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span class="x">// src/Acme/DemoBundle/Resources/config/services.php</span>
<span class="x">use Symfony\Component\DependencyInjection\Definition;</span>
<span class="x">use Symfony\Component\DependencyInjection\Reference;</span>

<span class="x">$container-&gt;setDefinition(&#39;wsse.security.authentication.provider&#39;,</span>
<span class="x">  new Definition(</span>
<span class="x">    &#39;Acme\DemoBundle\Security\Authentication\Provider\WsseProvider&#39;,</span>
<span class="x">    array(&#39;&#39;, &#39;%kernel.cache_dir%/security/nonces&#39;)</span>
<span class="x">));</span>

<span class="x">$container-&gt;setDefinition(&#39;wsse.security.authentication.listener&#39;,</span>
<span class="x">  new Definition(</span>
<span class="x">    &#39;Acme\DemoBundle\Security\Firewall\WsseListener&#39;, array(</span>
<span class="x">      new Reference(&#39;security.context&#39;),</span>
<span class="x">      new Reference(&#39;security.authentication.manager&#39;))</span>
<span class="x">));</span>
</pre></div>
</div>
</li>
</ul>
</div>
<p>Ahora que tus servicios están definidos, informa de tu fábrica al contexto de seguridad. Las fábricas se deben incluir en un archivo de configuración individual, al momento de escribir este artículo. Por lo tanto, empieza creando el archivo con el servicio fábrica, etiquetado como <tt class="docutils literal"><span class="pre">security.listener.factory</span></tt>:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># src/Acme/DemoBundle/Resources/config/security_factories.yml</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">security.authentication.factory.wsse</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">class</span><span class="p-Indicator">:</span>  <span class="l-Scalar-Plain">Acme\DemoBundle\DependencyInjection\Security\Factory\WsseFactory</span>
        <span class="l-Scalar-Plain">tags</span><span class="p-Indicator">:</span>
            <span class="p-Indicator">-</span> <span class="p-Indicator">{</span> <span class="nv">name</span><span class="p-Indicator">:</span> <span class="nv">security.listener.factory</span> <span class="p-Indicator">}</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- src/Acme/DemoBundle/Resources/config/security_factories.xml --&gt;</span>
<span class="nt">&lt;container</span> <span class="na">xmlns=</span><span class="s">&quot;http://symfony.com/schema/dic/services&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://symfony.com/schema/dic/services http://symfony.com/schema/dic/services/services-1.0.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;services&gt;</span>
        <span class="nt">&lt;service</span> <span class="na">id=</span><span class="s">&quot;security.authentication.factory.wsse&quot;</span>
          <span class="na">class=</span><span class="s">&quot;Acme\DemoBundle\DependencyInjection\Security\Factory\WsseFactory&quot;</span> <span class="na">public=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;tag</span> <span class="na">name=</span><span class="s">&quot;security.listener.factory&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/service&gt;</span>
    <span class="nt">&lt;/services&gt;</span>
<span class="nt">&lt;/container&gt;</span>
</pre></div>
</div>
</li>
</ul>
</div>
<p>Ahora, importa la configuración de fábrica vía la clave <tt class="docutils literal"><span class="pre">factories</span></tt> a tu configuración de seguridad:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># app/config/security.yml</span>
<span class="l-Scalar-Plain">security</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">factories</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="s">&quot;%kernel.root_dir%/../src/Acme/DemoBundle/Resources/config/security_factories.yml&quot;</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- app/config/security.xml --&gt;</span>
<span class="nt">&lt;config&gt;</span>
    <span class="nt">&lt;factories&gt;</span>
      &quot;%kernel.root_dir%/../src/Acme/DemoBundle/Resources/config/security_factories.xml
    <span class="nt">&lt;/factories&gt;</span>
<span class="nt">&lt;/config&gt;</span>
</pre></div>
</div>
</li>
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span class="x">// app/config/security.php</span>
<span class="x">$container-&gt;loadFromExtension(&#39;security&#39;, array(</span>
<span class="x">    &#39;factories&#39; =&gt; array(</span>
<span class="x">      &quot;%kernel.root_dir%/../src/Acme/DemoBundle/Resources/config/security_factories.php&quot;</span>
<span class="x">    ),</span>
<span class="x">));</span>
</pre></div>
</div>
</li>
</ul>
</div>
<p>¡Y está listo! Ahora puedes definir las partes de tu aplicación como bajo la protección del <em>WSSE</em>.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">security</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">firewalls</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">wsse_secured</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">pattern</span><span class="p-Indicator">:</span>   <span class="l-Scalar-Plain">/api/.*</span>
            <span class="l-Scalar-Plain">wsse</span><span class="p-Indicator">:</span>      <span class="l-Scalar-Plain">true</span>
</pre></div>
</div>
<p>¡Enhorabuena!  ¡Has escrito tu propio proveedor de autenticación de seguridad!</p>
</div>
<div class="section" id="un-poco-mas-alla">
<h2>Un poco más allá<a class="headerlink" href="#un-poco-mas-alla" title="Enlazar permanentemente con este título">¶</a></h2>
<p>¿Qué hay de hacer de tu proveedor de autenticación <em>WSSE</em> un poco más emocionante? Las posibilidades son infinitas. ¿Por qué no empezar agregando algo de brillo a la pasta?</p>
<div class="section" id="id1">
<h3>Configurando<a class="headerlink" href="#id1" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Puedes añadir opciones personalizadas bajo la clave <tt class="docutils literal"><span class="pre">wsse</span></tt> en tu configuración de seguridad.
Por ejemplo, el tiempo permitido antes de expirar el elemento de encabezado Creado, por omisión, es de 5 minutos. Hazlo configurable, por lo tanto distintos cortafuegos pueden tener diferentes magnitudes del tiempo de espera.</p>
<p>En primer lugar, tendrás que editar <tt class="docutils literal"><span class="pre">WsseFactory</span></tt> y definir la nueva opción en el método <tt class="docutils literal"><span class="pre">addConfiguration</span></tt>.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">class WsseFactory implements SecurityFactoryInterface</span>
<span class="x">{</span>
<span class="x">    # ...</span>

<span class="x">    public function addConfiguration(NodeDefinition $node)</span>
<span class="x">    {</span>
<span class="x">      $node</span>
<span class="x">        -&gt;children()</span>
<span class="x">        -&gt;scalarNode(&#39;lifetime&#39;)-&gt;defaultValue(300)</span>
<span class="x">        -&gt;end()</span>
<span class="x">      ;</span>
<span class="x">    }</span>
<span class="x">}</span>
</pre></div>
</div>
<p>Ahora, en el método <tt class="docutils literal"><span class="pre">create</span></tt> de la fábrica, el argumento <tt class="docutils literal"><span class="pre">$config</span></tt> contendrá una clave &#8220;lifetime&#8221;, establecida en 5 minutos (300 segundos) a menos que se establezca en la configuración. Pasa este argumento a tu proveedor de autenticación a fin de utilizarlo.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">class WsseFactory implements SecurityFactoryInterface</span>
<span class="x">{</span>
<span class="x">    public function create(ContainerBuilder $container, $id, $config, $userProvider, $defaultEntryPoint)</span>
<span class="x">    {</span>
<span class="x">        $providerId = &#39;security.authentication.provider.wsse.&#39;.$id;</span>
<span class="x">        $container</span>
<span class="x">            -&gt;setDefinition($providerId,</span>
<span class="x">              new DefinitionDecorator(&#39;wsse.security.authentication.provider&#39;))</span>
<span class="x">            -&gt;replaceArgument(0, new Reference($userProvider))</span>
<span class="x">            -&gt;replaceArgument(2, $config[&#39;lifetime&#39;])</span>
<span class="x">        ;</span>
<span class="x">        // ...</span>
<span class="x">    }</span>
<span class="x">    // ...</span>
<span class="x">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">También tendrás que añadir un tercer argumento a la configuración del servicio <tt class="docutils literal"><span class="pre">wsse.security.authentication.provider</span></tt>, el cual puede estar en blanco, pero se completará con la vida útil en la fábrica. La clase <tt class="docutils literal"><span class="pre">WsseProvider</span></tt> ahora también tiene que aceptar un tercer argumento en el constructor &#8212;<tt class="docutils literal"><span class="pre">lifetime</span></tt>&#8212; el cual se debe utilizar en lugar de los rígidos 300 segundos. Estos dos pasos no se muestran aquí.</p>
</div>
<p>La vida útil de cada petición <em>WSSE</em> ahora es configurable y se puede ajustar a cualquier valor deseado por el cortafuegos.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">security</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">firewalls</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">wsse_secured</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">pattern</span><span class="p-Indicator">:</span>   <span class="l-Scalar-Plain">/api/.*</span>
            <span class="l-Scalar-Plain">wsse</span><span class="p-Indicator">:</span>      <span class="p-Indicator">{</span> <span class="nv">lifetime</span><span class="p-Indicator">:</span> <span class="nv">30</span> <span class="p-Indicator">}</span>
</pre></div>
</div>
<p>¡El resto depende de ti! Todos los elementos de configuración correspondientes se pueden definir en la fábrica y consumirse o pasarse a las otras clases en el contenedor.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Contenidos</a></h3>
  <ul>
<li><a class="reference internal" href="#">Cómo crear un proveedor de autenticación personalizado</a><ul>
<li><a class="reference internal" href="#conociendo-wsse">Conociendo <em>WSSE</em></a></li>
<li><a class="reference internal" href="#el-testigo">El testigo</a></li>
<li><a class="reference internal" href="#el-escucha">El escucha</a></li>
<li><a class="reference internal" href="#proveedor-de-autenticacion">Proveedor de autenticación</a></li>
<li><a class="reference internal" href="#la-fabrica">La fábrica</a></li>
<li><a class="reference internal" href="#configurando">Configurando</a></li>
<li><a class="reference internal" href="#un-poco-mas-alla">Un poco más allá</a><ul>
<li><a class="reference internal" href="#id1">Configurando</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Tema anterior</h4>
  <p class="topless"><a href="custom_provider.html"
                        title="Capítulo anterior">Cómo crear un proveedor de usuario personalizado</a></p>
  <h4>Próximo tema</h4>
  <p class="topless"><a href="target_path.html"
                        title="Próximo capítulo">Cómo cambiar el comportamiento predeterminado de la ruta destino</a></p>
<div id="searchbox" style="display: none">
  <h3>Búsqueda rápida</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Ir a" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="Índice General"
             >índice</a></li>
        <li class="right" >
          <a href="target_path.html" title="Cómo cambiar el comportamiento predeterminado de la ruta destino"
             >siguiente</a> |</li>
        <li class="right" >
          <a href="custom_provider.html" title="Cómo crear un proveedor de usuario personalizado"
             >anterior</a> |</li>
        <li><a href="../../index.html">Symfony2</a> &raquo;</li>
          <li><a href="../index.html" >Recetario</a> &raquo;</li> 
      </ul>
    </div>
   <div id="disqus_thread"></div>
   
    <div class="footer">
        &copy; Copyright 2011, Traducido por Nacho Pacheco.
      Actualizado por última vez en Dec 05, 2011.
      Creado con <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.2.
    </div>
   <script type="text/javascript"> 
    var disqus_shortname = 'documentos-mx';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
   </script> 
   <noscript>
     Por favor activa JavaScript para ver los <a href="http://disqus.com/?ref_noscript">comentarios accionados por Disqus.</a>
   </noscript>

  </body>
</html>